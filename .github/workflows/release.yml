name: release

on:
  workflow_dispatch:
  schedule:
    - cron: '30 18 * * *'
  push:
    branches:
      - main
    paths:
      - CHANGELOG.md

permissions:
  contents: write
  actions: write
  issues: write

concurrency:
  group: "release-${{ github.ref }}"
  cancel-in-progress: true

jobs:
  release:
    runs-on: ubuntu-latest
    timeout-minutes: 25
    steps:
      - name: Checkout (full history for tags)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Print run URL
        run: |
          echo "Run URL: $GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID"

      - name: Ensure zip is available
        run: |
          if ! command -v zip >/dev/null 2>&1; then
            sudo apt-get update && sudo apt-get install -y zip
          fi

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install deps (best-effort)
        run: |
          npm config set fund false
          npm config set audit false
          npm ci --prefer-offline || npm install --legacy-peer-deps || true

      - name: Compute next tag (+1 patch) & KST date
        shell: bash
        run: |
          LAST=$(git tag -l "v*" --sort=-v:refname | head -n 1)
          [ -z "$LAST" ] && LAST="v0.0.0"
          V=${LAST#v}; IFS='.' read -r MA MI PA <<<"$V"
          NEXT="v${MA:-0}.${MI:-0}.$(( ${PA:-0} + 1 ))"
          echo "TAG=$NEXT" >> "$GITHUB_ENV"
          echo "REL_DATE=$(TZ=Asia/Seoul date +'%Y-%m-%d %H:%M KST')" >> "$GITHUB_ENV"

      - name: Build or fallback zip
        shell: bash
        run: |
          set -e
          HAS_BUILD=$(node -p "!!((require('./package.json').scripts||{}).build)" 2>/dev/null || echo false)
          if [ "$HAS_BUILD" = "true" ]; then
            npm run build || HAS_BUILD=false
          fi
          if [ "$HAS_BUILD" = "true" ] && [ -d dist ]; then
            zip -r build.zip dist
          elif [ "$HAS_BUILD" = "true" ] && [ -d build ]; then
            zip -r build.zip build
          else
            zip -r build.zip . -x ".git/*" ".github/*" "node_modules/*"
          fi
          echo "BUILD_PATH=$PWD/build.zip" >> "$GITHUB_ENV"

      - name: Publish release (create/update + upload)
        uses: ncipollo/release-action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag: ${{ env.TAG }}
          name: "Release ${{ env.TAG }} - ${{ env.REL_DATE }}"
          commitish: ${{ github.sha }}
          body: |
            ### Build
            - Attached: build.zip
            ### Release Date
            - ${{ env.REL_DATE }} (KST)
          makeLatest: true
          allowUpdates: true
          replacesArtifacts: true
          artifacts: ${{ env.BUILD_PATH }}